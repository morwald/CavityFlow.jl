@testset "linearstability.jl" begin
    @testset "f_linearstability" begin
        n = 6
        Re = 100
        p = CF.setup_struct(n, Re)

        u = ones((n - 3) * (n - 3))
        fu = similar(u)

        Ψ0 = CF.constructBC(u, p)

        Ψ = zeros(n + 1, n + 1)
        Ψ[3, 3] = 1.0
        CF.construct_homogenousBC!(Ψ, p)

        CF.f_linearstability!(fu, Ψ, Ψ0, p)

        fu_ref = [1.2532700933481635
            -83.76990750650569
            61.92471148087894
            65.18628709858737
            1.011358024691358
            -2.0662266431661656
            -47.760526841219956
            2.279452369179497
            -0.29330074522573635]

        @test fu ≈ fu_ref
    end
    @testset "linearstability_matrices!" begin
        n = 6
        Re = 100
        p = CF.setup_struct(n, Re)

        dim = (n - 3) * (n - 3)
        u = ones(dim)
        A = zeros(dim, dim)
        B = zeros(dim, dim)

        CF.linearstability_matrices!(A, B, u, p)

        Aref = [1.2532700933481635 95.4076891072863 -60.33656333273082 -82.63409711743618 -3.0370875567632467 5.219871684326349 49.34867498936811 -3.0301283156736614 -0.2933007452257381
            -83.76990750650569 8.026666666666607 76.4375618274934 14.955252909968056 -3.2399999999999527 -12.821919576634725 -2.6587116284387653 0.74666666666665 2.279452369179505
            61.92471148087894 -102.42102244061962 16.579816326405002 -5.619871684326353 5.287087556763273 75.62076378410266 0.3644118563368526 2.6301283156736517 -47.76052684121987
            65.18628709858737 -9.489191534476394 1.686967383906914 8.026666666666724 -3.2400000000000366 0.7466666666666782 -72.51863277759978 11.622524867809735 -2.0662266431661744
            1.011358024691358 -3.413333333333373 1.0113580246913578 -3.4133333333332967 7.200000000000001 -3.41333333333337 1.0113580246913592 -3.4133333333332936 1.011358024691359
            -2.0662266431661656 11.622524867809712 -72.51863277759958 0.7466666666666499 -3.239999999999959 8.026666666666609 1.6869673839069084 -9.489191534476387 65.1862870985873
            -47.760526841219956 2.6301283156736717 0.3644118563368437 75.62076378410288 5.287087556763209 -5.619871684326334 16.579816326404845 -102.42102244061951 61.9247114808789
            2.279452369179497 0.7466666666666781 -2.658711628438753 -12.821919576634699 -3.2400000000000424 14.955252909968033 76.43756182749321 8.026666666666722 -83.76990750650563
            -0.29330074522573635 -3.030128315673661 49.34867498936799 5.219871684326341 -3.037087556763238 -82.63409711743601 -60.33656333273073 95.40768910728619 1.2532700933481498]

        Bref = [-27.5555555555556 7.5 -1.33333333333333 7.5 0 0 -1.33333333333333 0 0
            7.11111111111112 -25.7777777777778 7.11111111111111 0 7.5 0 0 -1.33333333333333 0
            -1.33333333333333 7.49999999999999 -27.5555555555556 0 0 7.5 0 0 -1.33333333333333
            7.11111111111112 0 0 -25.7777777777778 7.5 -1.33333333333333 7.11111111111111 0 0
            0 7.11111111111112 0 7.11111111111112 -24 7.11111111111111 0 7.11111111111111 0
            0 0 7.11111111111112 -1.33333333333333 7.49999999999999 -25.7777777777778 0 0 7.11111111111111
            -1.33333333333333 0 0 7.49999999999999 0 0 -27.5555555555556 7.5 -1.33333333333333
            0 -1.33333333333333 0 0 7.49999999999999 0 7.11111111111112 -25.7777777777778 7.11111111111111
            0 0 -1.33333333333333 0 0 7.49999999999999 -1.33333333333333 7.49999999999999 -27.5555555555556]

        @test A ≈ Aref
        @test B ≈ Bref
    end
    @testset "linearstability_lambdas! and linearstability_lambdamax" begin
        n = 6
        Re = 100
        p = CF.setup_struct(n, Re)

        dim = (n - 3) * (n - 3)
        u = ones(dim)
        λ = similar(u)
        A = zeros(dim, dim)
        B = zeros(dim, dim)

        λ = real.(CF.linearstability_lambdas(u, p))
        λmax = CF.linearstability_lambdamax(Re, u, p)

        λref = [-0.135715953331695
            -0.214138856818600
            -0.214138856818600
            -0.239342607885019
            -0.270941697750084
            -0.270941697750084
            -0.347708607370327
            -0.347708607370327
            -0.439878235841015]

        @test λ ≈ λref
        @test λmax ≈ λref[1]
    end
    @testset "newton1D_for_linearstability" begin
        n = 8
        dim = (n - 3) * (n - 3)
        Re0 = 66
        p = CF.setup_struct(n, Re0)

        Ψ0 = zeros(n + 1, n + 1)
        Ψsteady, iter, tol = CF.steadystate(Ψ0, p)

        u0 = Ψsteady[3:(n - 1), 3:(n - 1)][:]

        Re, iter, tol = CF.newton1D_for_linearstability(Re0,
            u0,
            p;
            abstol = 1e-8,
            maxiters = 20)

        Re_ref = 68.943470270431973

        @test Re ≈ Re_ref
    end
end
